name: Release

on:
  workflow_dispatch:
    inputs:
      version_strategy:
        description: How to update version before release (none = use current build.clj/README).
        type: choice
        required: true
        default: none
        options:
          - none
          - sync-upstream
          - bump-clj-patch
          - set-version
      upstream_version:
        description: Required for sync-upstream; 3-segment upstream version like 0.1.23.
        type: string
        required: false
      explicit_version:
        description: Required for set-version; full 4-segment version, optional -SNAPSHOT.
        type: string
        required: false
      snapshot:
        description: Append -SNAPSHOT for sync-upstream/bump-clj-patch (ignored otherwise).
        type: boolean
        required: false
        default: false

permissions:
  contents: write
  id-token: write
  attestations: write

jobs:
  release:
    runs-on: ubuntu-latest
    env:
      HAS_GPG_KEY: ${{ secrets.GPG_PRIVATE_KEY != '' }}
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-java@v5
        with:
          distribution: 'temurin' # See 'Supported distributions' for available options
          java-version: '21'

      - name: Set up Clojure
        uses: DeLaGuardo/setup-clojure@13.5.2
        with:
          cli: latest
          bb: 1.12.214

      - name: Cache Clojure deps
        uses: actions/cache@v5
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
            ~/.deps.clj
            .cpcache
          key: cljdeps-${{ hashFiles('deps.edn', 'bb.edn') }}
          restore-keys: cljdeps-
      
      - name: Install BSD utils
        run: sudo apt-get update && sudo apt-get install -y libbsd-utils

      - name: Validate release inputs
        env:
          VERSION_STRATEGY: ${{ inputs.version_strategy }}
          UPSTREAM_VERSION: ${{ inputs.upstream_version }}
          EXPLICIT_VERSION: ${{ inputs.explicit_version }}
          SNAPSHOT: ${{ inputs.snapshot }}
        run: |
          set -euo pipefail
          case "$VERSION_STRATEGY" in
            none)
              if [[ -n "$UPSTREAM_VERSION" || -n "$EXPLICIT_VERSION" ]]; then
                echo "upstream_version/explicit_version must be empty when version_strategy=none." >&2
                exit 1
              fi
              if [[ "$SNAPSHOT" == "true" ]]; then
                echo "snapshot cannot be true when version_strategy=none." >&2
                exit 1
              fi
              ;;
            sync-upstream)
              if [[ -z "$UPSTREAM_VERSION" ]]; then
                echo "upstream_version is required when version_strategy=sync-upstream." >&2
                exit 1
              fi
              if [[ -n "$EXPLICIT_VERSION" ]]; then
                echo "explicit_version must be empty when version_strategy=sync-upstream." >&2
                exit 1
              fi
              if [[ ! "$UPSTREAM_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
                echo "upstream_version must match X.Y.Z (3 segments)." >&2
                exit 1
              fi
              ;;
            bump-clj-patch)
              if [[ -n "$UPSTREAM_VERSION" || -n "$EXPLICIT_VERSION" ]]; then
                echo "upstream_version/explicit_version must be empty when version_strategy=bump-clj-patch." >&2
                exit 1
              fi
              ;;
            set-version)
              if [[ -z "$EXPLICIT_VERSION" ]]; then
                echo "explicit_version is required when version_strategy=set-version." >&2
                exit 1
              fi
              if [[ -n "$UPSTREAM_VERSION" ]]; then
                echo "upstream_version must be empty when version_strategy=set-version." >&2
                exit 1
              fi
              if [[ ! "$EXPLICIT_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+(-SNAPSHOT)?$ ]]; then
                echo "explicit_version must match X.Y.Z.N or X.Y.Z.N-SNAPSHOT." >&2
                exit 1
              fi
              if [[ "$SNAPSHOT" == "true" ]]; then
                echo "snapshot is not used with set-version; include -SNAPSHOT in explicit_version." >&2
                exit 1
              fi
              ;;
            *)
              echo "Unknown version_strategy: $VERSION_STRATEGY" >&2
              exit 1
              ;;
          esac

      - name: Update version
        if: ${{ inputs.version_strategy != 'none' }}
        env:
          VERSION_STRATEGY: ${{ inputs.version_strategy }}
          UPSTREAM_VERSION: ${{ inputs.upstream_version }}
          EXPLICIT_VERSION: ${{ inputs.explicit_version }}
          SNAPSHOT: ${{ inputs.snapshot }}
        run: |
          set -euo pipefail
          args=()
          if [[ "$SNAPSHOT" == "true" ]]; then
            args+=(":snapshot" "true")
          fi
          case "$VERSION_STRATEGY" in
            sync-upstream)
              clj -T:build sync-version :upstream "\"${UPSTREAM_VERSION}\"" "${args[@]}"
              ;;
            bump-clj-patch)
              clj -T:build bump-version "${args[@]}"
              ;;
            set-version)
              clj -T:build bump-version :version "\"${EXPLICIT_VERSION}\""
              ;;
          esac

      - name: Configure git author
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Commit version update
        if: ${{ inputs.version_strategy != 'none' }}
        run: |
          set -euo pipefail
          if git diff --quiet; then
            echo "No version changes to commit."
            exit 0
          fi
          git add build.clj README.md
          git commit -m "chore: bump version for release"

      - name: Prepare GPG home
        if: ${{ env.HAS_GPG_KEY == 'true' }}
        run: |
          export GNUPGHOME="$RUNNER_TEMP/gnupg"
          mkdir -p "$GNUPGHOME"
          chmod 700 "$GNUPGHOME"

      - name: Import GPG key
        if: ${{ env.HAS_GPG_KEY == 'true' }}
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          export GNUPGHOME="$RUNNER_TEMP/gnupg"
          printf '%s' "$GPG_PRIVATE_KEY" | gpg --batch --import --no-tty --quiet

      - name: Update README SHA
        run: bb readme:sha

      - name: Commit README SHA update
        run: |
          set -euo pipefail
          if git diff --quiet README.md; then
            echo "README.md SHA already up to date."
            exit 0
          fi
          git add README.md
          git commit -m "chore: update README SHA"

      - name: Push release metadata
        if: ${{ github.ref_type == 'branch' }}
        run: |
          set -euo pipefail
          git push origin "HEAD:${GITHUB_REF_NAME}"

      - name: Deploy to Maven Central
        env:
          CENTRAL_USERNAME: ${{ secrets.CENTRAL_USERNAME }}
          CENTRAL_PASSWORD: ${{ secrets.CENTRAL_PASSWORD }}
          GNUPGHOME: ${{ runner.temp }}/gnupg
        run: clj -T:build deploy-central

      - name: Identify release artifacts
        id: artifacts
        run: |
          jar=$(ls target/io.github.copilot-community-sdk/copilot-sdk-clojure-*.jar)
          bundle=$(ls target/copilot-sdk-clojure-*-bundle.zip 2>/dev/null || true)
          echo "jar=$jar" >> "$GITHUB_OUTPUT"
          echo "bundle=$bundle" >> "$GITHUB_OUTPUT"

      - name: Attest JAR provenance
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: ${{ steps.artifacts.outputs.jar }}

      - name: Attest bundle provenance
        if: ${{ steps.artifacts.outputs.bundle != '' }}
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: ${{ steps.artifacts.outputs.bundle }}

      - name: Cleanup GPG home
        if: ${{ always() && env.HAS_GPG_KEY == 'true' }}
        run: rm -rf "$RUNNER_TEMP/gnupg"
